<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client</title>
</head>
<body>
    <h1>Live Link V1.0.3</h1>
    <input type="text" id="addressInput" placeholder="Enter Host Address...">
    <button id="accelPermsButton" onclick="getMotion()" style="height:50px;">Get Accelerometer Permissions</button>
    <button onclick="beginSend()">Start Transfer</button>

    <script>
        var transmitting = false;

        function beginSend()
        {
            transmitting = true;
        }

        function sendData(message)
        {
            if (!transmitting)
                return;

            const PORT = 8080;
            const HOST = document.getElementById('addressInput').value;

            fetch(`http://${HOST}:${PORT}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain'
                },
                body: message
            })
            .then(response => response.text())
            .then(data => {
                console.log('Data from server:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function getMotion()
        {
            console.log("getMotion");
            DeviceMotionEvent.requestPermission().then(response => {
                console.log("requesting");
                console.log(response);
                if (response == 'granted')
                {
                    // Add a listener to get smartphone orientation 
                    // in the alpha-beta-gamma axes (units in degrees)
                    window.addEventListener('devicemotion', (motion) => {
                        console.log("devicemotion");
                        accelerationX = motion.accelerationIncludingGravity.x; // Acceleration along the x-axis
                        accelerationY = motion.accelerationIncludingGravity.y; // Acceleration along the y-axis
                        accelerationZ = motion.accelerationIncludingGravity.z; // Acceleration along the z-axis
                        rotationRateAlpha = motion.rotationRate.alpha; // Rate of rotation around the z-axis
                        rotationRateBeta = motion.rotationRate.beta; // Rate of rotation around the x-axis
                        rotationRateGamma = motion.rotationRate.gamma; // Rate of rotation around the y-axis
                        
                        sendData("motion:\nacceleration:\t" + "<" + accelerationX + ", " + accelerationY + ", " + accelerationZ + ">" + "\nrotation rate\t" + "<" + rotationRateBeta + ", " + rotationRateGamma + ", " + rotationRateAlpha + ">");
                    });
                    window.addEventListener('deviceorientation', (event) => {
                        console.log("deviceorientation");
                        rotation_degrees = event.alpha; // compass tilt
                        frontToBack_degrees = event.beta;
                        leftToRight_degrees = event.gamma;

                        sendData("orientation:\n\t" + "<" + frontToBack_degrees + ", " + leftToRight_degrees + ", " + rotation_degrees + ">");
                    });
                }
            });
        }
    </script>
</body>
</html>
